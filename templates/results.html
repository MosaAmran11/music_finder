<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Song Info</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <link rel="stylesheet" href="static/style.css" />
  </head>
  <body class="bg-light">
    <div class="container mt-5">
      <!-- Navigation Header -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="d-flex justify-content-between align-items-center">
            <h2 class="mb-0">
              <i class="bi bi-music-note-beamed"></i> Song Info Finder
            </h2>
            <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
              <i class="bi bi-arrow-left"></i> Upload Another File
            </a>
          </div>
          <hr class="my-3" />
        </div>
      </div>

      <div id="results-section">
        <div class="row flex-lg-row flex-column">
          <!-- Left: Matches -->
          <div class="col-lg-6 mb-4">
            <h3 class="mb-3"><i class="bi bi-star"></i> Best Match</h3>
            {% set best_match_index = 0 if results and results[0] is not none
            else -1 %} {% set best_match = results[best_match_index] if
            best_match_index != -1 else None %} {% if best_match %}
            <div
              class="card match-card mb-3 selected"
              id="match-card-0"
              data-match-index="0"
            >
              <div class="card-body">
                <div class="cover-image-container">
                  {% if best_match.thumbnailUrl %}
                  <img
                    src="{{ best_match.thumbnailUrl }}"
                    alt="Album Cover"
                    class="img-fluid rounded"
                  />
                  {% else %}
                  <div class="placeholder-cover">No Cover</div>
                  {% endif %}
                </div>
                <div class="match-info">
                  <div class="fw-bold">{{ best_match.title or 'N/A' }}</div>
                  <div>{{ best_match.artist or 'N/A' }}</div>
                  <div class="text-muted">
                    {{ best_match.album or 'N/A' }}{% if best_match.date %} ({{
                    best_match.date }}){% endif %}
                  </div>
                </div>
                <div class="match-actions">
                  <button
                    class="btn btn-primary btn-sm use-tags-btn"
                    data-match-index="0"
                  >
                    <i class="bi bi-arrow-down-circle"></i> Use These Tags
                  </button>
                </div>
              </div>
            </div>
            {% endif %}

            <h5 class="mb-2">Other Matches</h5>
            <div class="scrollable-matches">
              {% for loop_index, track in enumerate(results) %} {% if track is
              not none and loop_index != 0 %}
              <div
                class="card match-card mb-2"
                id="match-card-{{ loop_index }}"
                data-match-index="{{ loop_index }}"
              >
                <div class="card-body">
                  <div class="cover-image-container">
                    {% if track.thumbnailUrl %}
                    <img
                      src="{{ track.thumbnailUrl }}"
                      alt="Album Cover"
                      class="img-fluid rounded"
                    />
                    {% else %}
                    <div class="placeholder-cover">No Cover</div>
                    {% endif %}
                  </div>
                  <div class="match-info">
                    <div class="fw-bold">{{ track.title or 'N/A' }}</div>
                    <div>{{ track.artist or 'N/A' }}</div>
                    <div class="text-muted">
                      {{ track.album or 'N/A' }}{% if track.date %} ({{
                      track.date[:4] }}){% endif %}
                    </div>
                  </div>
                  <div class="match-actions">
                    <button
                      class="btn btn-outline-primary btn-sm use-tags-btn"
                      data-match-index="{{ loop_index }}"
                    >
                      <i class="bi bi-arrow-down-circle"></i> Use These Tags
                    </button>
                  </div>
                </div>
              </div>
              {% endif %} {% endfor %}
            </div>
          </div>

          <!-- Right: Metadata Form -->
          <div class="col-lg-6">
            <div class="card shadow mb-4">
              <div class="card-body">
                <h4 class="section-title">
                  <i class="bi bi-pencil-square"></i> Metadata Fields
                </h4>
                <form
                  id="metadata-form"
                  method="POST"
                  action="{{ url_for('save_metadata') }}"
                >
                  <input
                    type="hidden"
                    name="filepath"
                    value="{{ metadata.filepath }}"
                  />
                  <input
                    type="hidden"
                    id="thumbnailUrl"
                    name="thumbnailUrl"
                    value="{{ results[0].thumbnailUrl if results and results[0] and results[0].thumbnailUrl else '' }}"
                  />
                  <div class="info-box">
                    <div class="metadata-field">
                      <label for="title">Title:</label>
                      <input
                        type="text"
                        id="title"
                        name="title"
                        value="{{ metadata.title or '' }}"
                      />
                    </div>
                    <div class="metadata-field">
                      <label for="artist">Artist:</label>
                      <input
                        type="text"
                        id="artist"
                        name="artist"
                        value="{{ metadata.artist or '' }}"
                      />
                    </div>
                    <div class="metadata-field">
                      <label for="album">Album Name:</label>
                      <input
                        type="text"
                        id="album"
                        name="album"
                        value="{{ metadata.album or '' }}"
                      />
                    </div>
                    <div class="metadata-field">
                      <label for="genre">Genre:</label>
                      <input
                        type="text"
                        id="genre"
                        name="genre"
                        value="{{ metadata.genre or '' }}"
                      />
                    </div>
                    <div class="metadata-field">
                      <label for="tracknumber">Track Number:</label>
                      <input
                        type="text"
                        id="tracknumber"
                        name="tracknumber"
                        value="{{ metadata.tracknumber or '' }}"
                      />
                    </div>
                    <div class="metadata-field">
                      <label for="discnumber">Disc Number:</label>
                      <input
                        type="text"
                        id="discnumber"
                        name="discnumber"
                        value="{{ metadata.discnumber or '' }}"
                      />
                    </div>
                    <div class="metadata-field">
                      <label for="albumartist">Album Artist:</label>
                      <input
                        type="text"
                        id="albumartist"
                        name="albumartist"
                        value="{{ metadata.albumartist or '' }}"
                      />
                    </div>
                    <div class="metadata-field">
                      <label for="year">Year:</label>
                      <input
                        type="text"
                        id="year"
                        name="date"
                        value="{{ metadata.date[:4] if metadata.date else '' }}"
                      />
                    </div>
                  </div>
                  <div class="d-flex justify-content-between mt-3">
                    <button
                      type="button"
                      class="btn btn-secondary"
                      id="reset-tags-btn"
                    >
                      <i class="bi bi-arrow-counterclockwise"></i> Reset to File
                      Tags
                    </button>
                    <div>
                      <button
                        type="button"
                        class="btn btn-info me-2"
                        id="refresh-btn"
                        disabled
                      >
                        <i class="bi bi-arrow-repeat"></i> Refresh
                      </button>
                      <button type="submit" class="btn btn-success">
                        <i class="bi bi-save"></i> Save Metadata
                      </button>
                    </div>
                  </div>
                  {% if metadata.filepath %}
                  <div class="path-info mt-2">
                    <strong>Path:</strong> {{ metadata.filepath }}
                  </div>
                  {% endif %} {% if metadata.str_bitrate %}
                  <div class="path-info">
                    <strong>Bitrate:</strong> {{ metadata.str_bitrate }}
                  </div>
                  {% endif %}
                </form>

                <!-- Separate form for refresh functionality -->
                <form
                  id="refresh-form"
                  method="POST"
                  action="{{ url_for('index') }}"
                  style="display: none"
                >
                  <input
                    type="hidden"
                    name="filepath"
                    value="{{ metadata.filepath }}"
                  />
                  <input type="hidden" name="refresh" value="1" />
                  <input type="hidden" name="title" id="refresh-title" />
                  <input type="hidden" name="artist" id="refresh-artist" />
                  <input type="hidden" name="album" id="refresh-album" />
                  <input type="hidden" name="genre" id="refresh-genre" />
                  <input
                    type="hidden"
                    name="tracknumber"
                    id="refresh-tracknumber"
                  />
                  <input
                    type="hidden"
                    name="discnumber"
                    id="refresh-discnumber"
                  />
                  <input
                    type="hidden"
                    name="albumartist"
                    id="refresh-albumartist"
                  />
                  <input type="hidden" name="date" id="refresh-date" />
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Store match data as JSON scripts -->
    <div id="match-data" style="display: none">
      {% for loop_index, track in enumerate(results) %} {% if track is not none
      %}
      <script id="match-{{ loop_index }}-data" type="application/json">
        {{ track | tojson | safe }}
      </script>
      {% endif %} {% endfor %}
      <script id="file-tags-data" type="application/json">
        {{ metadata.to_dict() | tojson | safe }}
      </script>
    </div>

    <!-- Snackbar/Toast for Save Success/Error/Warning -->
    <div
      id="saveSnackbar"
      class="toast align-items-center border-0 position-fixed bottom-0 end-0 m-4"
      role="alert"
      aria-live="assertive"
      aria-atomic="true"
      style="z-index: 9999; min-width: 250px; display: none"
    >
      <div class="d-flex">
        <div class="toast-body" id="saveSnackbarMsg">
          <!-- Message will be set by JS -->
        </div>
        <button
          type="button"
          class="btn-close btn-close-white me-2 m-auto"
          data-bs-dismiss="toast"
          aria-label="Close"
        ></button>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Highlight selected match
        let selectedMatchIndex = 0;
        function highlightMatch(index) {
          document
            .querySelectorAll(".match-card")
            .forEach((card) => card.classList.remove("selected"));
          const card = document.getElementById("match-card-" + index);
          if (card) card.classList.add("selected");
        }

        // Function to get match data by index
        function getMatchData(index) {
          const scriptElement = document.getElementById(
            "match-" + index + "-data"
          );
          if (scriptElement) {
            try {
              return JSON.parse(scriptElement.textContent);
            } catch (e) {
              console.error(
                "Error parsing JSON for match index ",
                index,
                ":",
                e
              );
              return null;
            }
          } else {
            return null;
          }
        }
        // Function to get file tags
        function getFileTags() {
          const scriptElement = document.getElementById("file-tags-data");
          if (scriptElement) {
            try {
              return JSON.parse(scriptElement.textContent);
            } catch (e) {
              return null;
            }
          } else {
            return null;
          }
        }
        // Function to populate metadata fields
        function populateMetadataFields(data) {
          document.getElementById("title").value = data.title || "";
          document.getElementById("artist").value = data.artist || "";
          document.getElementById("album").value = data.album || "";
          document.getElementById("genre").value = data.genre || "";
          document.getElementById("tracknumber").value = data.tracknumber || "";
          document.getElementById("discnumber").value = data.discnumber || "";
          document.getElementById("albumartist").value = data.albumartist || "";
          document.getElementById("year").value = data.date
            ? data.date.substring(0, 4)
            : "";
          document.getElementById("thumbnailUrl").value =
            data.thumbnailUrl || "";
        }
        // Use These Tags button click
        document.querySelectorAll(".use-tags-btn").forEach((btn) => {
          btn.addEventListener("click", function (e) {
            e.preventDefault();
            const index = this.dataset.matchIndex;
            const matchData = getMatchData(index);
            if (matchData) {
              populateMetadataFields(matchData);
              highlightMatch(index);
              selectedMatchIndex = index;
            }
          });
        });
        // Match card click (anywhere on card)
        document.querySelectorAll(".match-card").forEach((card) => {
          card.addEventListener("click", function (e) {
            // Prevent double trigger if button is clicked
            if (e.target.closest(".use-tags-btn")) return;
            const index = this.dataset.matchIndex;
            const matchData = getMatchData(index);
            if (matchData) {
              populateMetadataFields(matchData);
              highlightMatch(index);
              selectedMatchIndex = index;
            }
          });
        });
        // Reset to file tags
        document
          .getElementById("reset-tags-btn")
          .addEventListener("click", function () {
            const fileTags = getFileTags();
            if (fileTags) {
              populateMetadataFields(fileTags);
              highlightMatch("0");
              selectedMatchIndex = 0;
            }
          });
        // Snackbar show function
        function showSnackbar(message, type = "success") {
          const snackbar = document.getElementById("saveSnackbar");
          const msg = document.getElementById("saveSnackbarMsg");
          msg.textContent = message;
          snackbar.classList.remove(
            "text-bg-success",
            "text-bg-danger",
            "text-bg-warning"
          );
          if (type === "success") snackbar.classList.add("text-bg-success");
          else if (type === "error") snackbar.classList.add("text-bg-danger");
          else if (type === "warning")
            snackbar.classList.add("text-bg-warning");
          snackbar.style.display = "block";
          const toast = new bootstrap.Toast(snackbar, { delay: 2500 });
          toast.show();
          setTimeout(() => {
            snackbar.style.display = "none";
          }, 2600);
        }
        // Intercept metadata form submit and use AJAX
        document
          .getElementById("metadata-form")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            const form = this;
            const formData = new FormData(form);
            fetch(form.action, {
              method: "POST",
              body: formData,
              headers: {
                "X-Requested-With": "XMLHttpRequest",
              },
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.success) {
                  showSnackbar(
                    "✓ " + (data.message || "Metadata saved successfully!"),
                    "success"
                  );
                } else {
                  showSnackbar(
                    "⚠ " + (data.message || "Could not save metadata."),
                    "error"
                  );
                }
              })
              .catch(() => {
                showSnackbar("✗ Error: Could not save metadata.", "error");
              });
          });
        // --- Refresh Button Logic ---
        const refreshBtn = document.getElementById("refresh-btn");
        const form = document.getElementById("metadata-form");
        // Store original values
        const originalValues = {};
        [
          "title",
          "artist",
          "album",
          "genre",
          "tracknumber",
          "discnumber",
          "albumartist",
          "year",
        ].forEach((id) => {
          const el = document.getElementById(id);
          if (el) originalValues[id] = el.value;
        });
        // Enable refresh if any field changes
        form.querySelectorAll("input,textarea").forEach((input) => {
          input.addEventListener("input", function () {
            let changed = false;
            for (const id in originalValues) {
              const el = document.getElementById(id);
              if (el && el.value !== originalValues[id]) {
                changed = true;
                break;
              }
            }
            refreshBtn.disabled = !changed;
          });
        });
        // Refresh button click handler
        refreshBtn.addEventListener("click", function () {
          // Copy current field values to refresh form
          document.getElementById("refresh-title").value =
            document.getElementById("title").value;
          document.getElementById("refresh-artist").value =
            document.getElementById("artist").value;
          document.getElementById("refresh-album").value =
            document.getElementById("album").value;
          document.getElementById("refresh-genre").value =
            document.getElementById("genre").value;
          document.getElementById("refresh-tracknumber").value =
            document.getElementById("tracknumber").value;
          document.getElementById("refresh-discnumber").value =
            document.getElementById("discnumber").value;
          document.getElementById("refresh-albumartist").value =
            document.getElementById("albumartist").value;
          document.getElementById("refresh-date").value =
            document.getElementById("year").value;

          refreshBtn.disabled = true;
          document.getElementById("refresh-form").submit();
        });
      });
    </script>
  </body>
</html>
